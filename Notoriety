--[[
    XXMZ HUB - Notoriety
    Improved Version v2.0
    By 29 :)
    
    Improvements:
    - Kill Aura fixed and optimized
    - TP Walk loading bug resolved
    - Improved security system
    - Optimized performance
    - Cleaner and organized code
]]
loadstring(game:HttpGet("https://raw.githubusercontent.com/XScommunity/XXMZ/refs/heads/main/tinc"))()
-- ==================== INITIALIZATION ====================
local Fluent = nil
local Success, Result = pcall(function()
    return game:HttpGet("https://twix.cyou/Fluent.txt", true)
end)

if Success and typeof(Result) == "string" and string.find(Result, "dawid") then
    Fluent = getfenv().loadstring(Result)()
else
    Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
end

-- ==================== SERVICES ====================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = Workspace.CurrentCamera

-- ==================== WINDOW CREATION ====================
local Window = Fluent:CreateWindow({
    Title = "XXMZ HUB - Notoriety v2.0",
    SubTitle = "by 29 :) - Improved Version",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Theme = "VSC Dark High Contrast",
    Acrylic = false,
    MinimizeKey = Enum.KeyCode.RightShift
})

-- ==================== VARIABLES ====================
-- Weapons
local selectedGun = "M16"
local selectedClass = "Class 1"

-- Interact
local instantInteractEnabled = false
local instantInteractConnection = nil

-- Player Mod
local infiniteStaminaEnabled = false
local infiniteStaminaLoop = nil

local walkSpeedEnabled = false
local walkSpeedValue = 50
local tpWalkConnection = nil

local infiniteJumpEnabled = false
local infJumpConnection = nil

local noclipEnabled = false
local noclipLoop = nil

local gravityValue = 196.2
local customGravityEnabled = false
local gravityLoop = nil

-- ESP
local cameraESPEnabled = false
local policeESPEnabled = false
local civilianESPEnabled = false
local cameraHighlights = {}
local policeHighlights = {}
local civilianHighlights = {}
local espLoops = {}

-- Map-Specific ESP
local selectedMap = "The Ozela Heist"
local ropeESPEnabled = false
local hookESPEnabled = false
local codeTableESPEnabled = false
local ropeHighlights = {}
local hookHighlights = {}
local codeTableHighlights = {}
local ropeESPLoop = nil
local hookESPLoop = nil
local codeTableESPLoop = nil

-- Aim
local aimEnabled = false
local aimPart = "Head"
local aimFOV = 200
local aimSensitivity = 50
local useSensitivity = true
local fovCircleEnabled = false
local currentTarget = nil
local aiming = false

-- Kill Aura
local kaEnabled = false
local kaRange = 70
local kaDelay = 0.1
local lastKaTime = 0
local kaAutoAim = true

-- Kill All
local killAllEnabled = false
local killAllDelay = 0.5
local killAllNotifyDelay = 5
local lastKillAllNotify = 0

-- ==================== UTILITY FUNCTIONS ====================
local function getRS()
    return ReplicatedStorage:WaitForChild("RS_Package", 5)
end

local function notify(title, content, duration)
    Fluent:Notify({
        Title = title,
        Content = content,
        Duration = duration or 3
    })
end

local function safeCall(func, errorMsg)
    local success, err = pcall(func)
    if not success and errorMsg then
        warn(errorMsg .. ": " .. tostring(err))
    end
    return success
end

-- ==================== HIGHLIGHT FUNCTIONS ====================
local function createHighlight(object, color)
    if not object or not object:IsDescendantOf(Workspace) then return nil end
    
    local highlight = Instance.new("Highlight")
    highlight.FillColor = color
    highlight.OutlineColor = color
    highlight.FillTransparency = 0.4
    highlight.OutlineTransparency = 0
    highlight.Adornee = object
    highlight.Parent = object
    
    return highlight
end

local function clearHighlights(table)
    for i = #table, 1, -1 do
        if table[i] then
            safeCall(function()
                table[i]:Destroy()
            end)
        end
        table[i] = nil
    end
end

-- ==================== FOV CIRCLE ====================
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 2
FOVCircle.NumSides = 100
FOVCircle.Radius = aimFOV
FOVCircle.Filled = false
FOVCircle.Visible = false
FOVCircle.Color = Color3.fromRGB(255, 255, 255)
FOVCircle.Transparency = 1

-- ==================== WEAPON FUNCTIONS ====================
local function getEquippedWeapon()
    local character = LocalPlayer.Character
    if not character then return nil end
    
    local tool = character:FindFirstChildOfClass("Tool")
    return tool
end

local function buffCurrentWeapon()
    safeCall(function()
        local charFolder = Workspace.Criminals:FindFirstChild(LocalPlayer.Name)
        if not charFolder then 
            notify("Error", "You are not in Criminals!")
            return 
        end
        
        local buffed = 0
        for _, obj in pairs(charFolder:GetChildren()) do
            local dataModule = obj:FindFirstChild("Data")
            if dataModule and dataModule:IsA("ModuleScript") then
                local weaponData = require(dataModule)
                
                -- Super buffs
                weaponData["Damage"] = 9999
                weaponData["FireDelay"] = 0.01
                weaponData["MagazineSize"] = 999
                weaponData["AmmoMax"] = 999
                weaponData["RecoilSpeed"] = 0
                weaponData["Accuracy"] = 100
                weaponData["ShakeMagnitude"] = 0
                weaponData["ShakeRoughness"] = 0
                weaponData["RecoilDirectionPattern"] = {Vector2.new(0,0)}
                weaponData["RecoilCameraDirectionPattern"] = {Vector2.new(0,0)}
                weaponData["BulletSpeed"] = 5000
                weaponData["ReloadTime"] = 0.1
                weaponData["LongerReloadTime"] = 0.1
                
                buffed = buffed + 1
            end
        end
        
        if buffed > 0 then
            notify("Weapon Modified", buffed .. " weapon(s) buffed!", 4)
        else
            notify("Warning", "No weapon found to modify")
        end
    end, "Error modifying weapon")
end

-- ==================== AIM FUNCTIONS ====================
local function getClosestPolice()
    local closest = nil
    local shortestDistance = aimFOV
    
    for _, folderName in ipairs({"Police", "Bodies"}) do
        local folder = Workspace:FindFirstChild(folderName)
        if folder then
            for _, npc in pairs(folder:GetChildren()) do
                if npc and npc:FindFirstChild(aimPart) then
                    local humanoid = npc:FindFirstChildOfClass("Humanoid")
                    if humanoid and humanoid.Health > 0 then
                        local targetPart = npc:FindFirstChild(aimPart)
                        local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
                        
                        if onScreen then
                            local mousePos = Vector2.new(Mouse.X, Mouse.Y)
                            local targetPos = Vector2.new(screenPos.X, screenPos.Y)
                            local distance = (mousePos - targetPos).Magnitude
                            
                            if distance < shortestDistance then
                                closest = npc
                                shortestDistance = distance
                            end
                        end
                    end
                end
            end
        end
    end
    
    return closest
end

local function aimAtTarget(target)
    if not target or not target:FindFirstChild(aimPart) then return end
    
    local targetPart = target:FindFirstChild(aimPart)
    if not targetPart then return end
    
    local targetPos = targetPart.Position
    local cameraPos = Camera.CFrame.Position
    
    if useSensitivity then
        local lookAt = CFrame.new(cameraPos, targetPos)
        local lerpAmount = aimSensitivity / 100
        Camera.CFrame = Camera.CFrame:Lerp(lookAt, lerpAmount)
    else
        Camera.CFrame = CFrame.new(cameraPos, targetPos)
    end
end

-- ==================== KILL AURA FUNCTIONS ====================
local function executeKillAura(target)
    if not target then return false end
    
    local humanoid = target:FindFirstChild("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end
    
    local weapon = getEquippedWeapon()
    if not weapon then return false end
    
    local targetPart = target:FindFirstChild("Head") or target:FindFirstChild("UpperTorso") or target:FindFirstChild("Torso")
    if not targetPart then return false end
    
    local success = safeCall(function()
        local rs = getRS()
        if not rs then return end
        
        -- Method 1: Direct damage
        local damageArgs = {
            "Damage",
            weapon,
            humanoid,
            150, -- Increased damage
            targetPart,
            weapon.Name,
            Vector3.new(0, 0, 0),
            {}
        }
        
        rs.Assets.Remotes.Damage:FireServer(unpack(damageArgs))
        
        -- Method 2: Backup with multiple hits
        task.wait(0.01)
        rs.Assets.Remotes.Damage:FireServer(unpack(damageArgs))
    end)
    
    return success
end

local function killAllPolice()
    local weapon = getEquippedWeapon()
    if not weapon then 
        notify("Kill All", "Hold a weapon first!")
        return 
    end
    
    local killedCount = 0
    local totalPolice = 0
    local batchSize = 3 -- Process 3 police at a time
    
    for _, folderName in ipairs({"Police", "Bodies"}) do
        local folder = Workspace:FindFirstChild(folderName)
        if folder then
            for _, npc in pairs(folder:GetChildren()) do
                if npc and npc:FindFirstChildOfClass("Humanoid") then
                    local humanoid = npc:FindFirstChildOfClass("Humanoid")
                    if humanoid.Health > 0 then
                        totalPolice = totalPolice + 1
                        
                        if executeKillAura(npc) then
                            killedCount = killedCount + 1
                        end
                        
                        -- Delay every batch to reduce lag
                        if killedCount % batchSize == 0 then
                            task.wait(0.03)
                        end
                    end
                end
            end
        end
    end
    
    -- Notification only every 5 seconds when in loop
    local currentTime = tick()
    if not killAllEnabled or (currentTime - lastKillAllNotify >= killAllNotifyDelay) then
        if totalPolice > 0 then
            notify("Kill All", string.format("%d/%d targets attacked", killedCount, totalPolice), 2)
        else
            notify("Kill All", "No police found", 2)
        end
        lastKillAllNotify = currentTime
    end
end

-- ==================== DESTRUCTION FUNCTIONS ====================
local function getTool()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
end

local function fireHit(tool, hitPart)
    if not tool or not hitPart then return false end
    
    return safeCall(function()
        local rs = getRS()
        if not rs then return end
        
        local args = {
            [1] = tool,
            [2] = hitPart,
            [3] = false,
            [6] = Vector3.new(0, 0, 0),
            [7] = 90,
            [9] = hitPart.Position
        }
        
        rs.Assets.Remotes.HitObject:FireServer(unpack(args, 1, 9))
    end)
end

-- ==================== TABS ====================
local Tabs = {
    Weapons = Window:AddTab({ Title = "Weapons", Icon = "target" }),
    Interact = Window:AddTab({ Title = "Interactions", Icon = "hand" }),
    Destruction = Window:AddTab({ Title = "Destruction", Icon = "bomb" }),
    Player = Window:AddTab({ Title = "Player Mod", Icon = "user" }),
    Aim = Window:AddTab({ Title = "Combat", Icon = "crosshair" }),
    ESP = Window:AddTab({ Title = "ESP", Icon = "eye" }),
    Maps = Window:AddTab({ Title = "Specific Maps", Icon = "map" }),
    Stats = Window:AddTab({ Title = "Game Stats", Icon = "bar-chart" })
}

-- ==================== WEAPONS TAB ====================
Tabs.Weapons:AddSection("Modify Weapons")

Tabs.Weapons:AddButton({
    Title = "üî• Modify Current Weapon (OP)",
    Description = "9999 Damage, No Recoil, Max Fire Rate",
    Callback = buffCurrentWeapon
})

Tabs.Weapons:AddSection("Get Weapons")

Tabs.Weapons:AddInput("GunName", {
    Title = "Weapon Name",
    Default = "M16",
    Placeholder = "Ex: M16, AK47, Shotgun",
    Callback = function(value)
        selectedGun = value
    end
})

Tabs.Weapons:AddInput("ClassName", {
    Title = "Class Name",
    Default = "Class 1",
    Placeholder = "Ex: Class 1, Class 2",
    Callback = function(value)
        selectedClass = value
    end
})

Tabs.Weapons:AddButton({
    Title = "Get Weapon Data",
    Description = "Retrieves weapon information",
    Callback = function()
        safeCall(function()
            local rs = getRS()
            if rs then
                rs.Remotes.GetGunData:InvokeServer(selectedGun)
                notify("Weapons", "Data obtained: " .. selectedGun)
            end
        end, "Error getting data")
    end
})

Tabs.Weapons:AddButton({
    Title = "Set Weapon to Class",
    Description = "Assigns weapon to selected class",
    Callback = function()
        safeCall(function()
            local rs = getRS()
            if rs then
                rs.Remotes.SetGunForClass:FireServer(selectedClass, selectedGun, 0)
                notify("Weapons", selectedGun .. " ‚Üí " .. selectedClass)
            end
        end, "Error setting weapon")
    end
})

Tabs.Weapons:AddButton({
    Title = "Activate Class",
    Description = "Equips the selected class",
    Callback = function()
        safeCall(function()
            local rs = getRS()
            if rs then
                rs.Remotes.SetClass:FireServer(selectedClass)
                notify("Weapons", "Class activated: " .. selectedClass)
            end
        end, "Error activating class")
    end
})

-- ==================== INTERACT TAB ====================
Tabs.Interact:AddSection("Quick Interactions")

Tabs.Interact:AddToggle("InstantInteract", {
    Title = "‚ö° Instant Interact",
    Description = "Removes hold time on all prompts",
    Default = false,
    Callback = function(value)
        instantInteractEnabled = value
        
        -- Clear previous connection
        if instantInteractConnection then
            instantInteractConnection:Disconnect()
            instantInteractConnection = nil
        end
        
        if value then
            -- Apply to all existing prompts
            for _, obj in pairs(Workspace:GetDescendants()) do
                if obj:IsA("ProximityPrompt") then
                    obj.HoldDuration = 0
                    obj.MaxActivationDistance = 20
                    obj.RequiresLineOfSight = false
                end
            end
            
            -- Listen for new prompts
            instantInteractConnection = Workspace.DescendantAdded:Connect(function(obj)
                if instantInteractEnabled and obj:IsA("ProximityPrompt") then
                    task.wait()
                    obj.HoldDuration = 0
                    obj.MaxActivationDistance = 20
                    obj.RequiresLineOfSight = false
                end
            end)
            
            notify("Interact", "Instant Interact ENABLED!", 2)
        else
            notify("Interact", "Instant Interact disabled", 2)
        end
    end
})

Tabs.Interact:AddButton({
    Title = "Apply Instant Interact Now",
    Description = "Forces immediate application",
    Callback = function()
        local count = 0
        for _, obj in pairs(Workspace:GetDescendants()) do
            if obj:IsA("ProximityPrompt") then
                obj.HoldDuration = 0
                obj.MaxActivationDistance = 20
                obj.RequiresLineOfSight = false
                count = count + 1
            end
        end
        notify("Interact", count .. " prompts modified!", 3)
    end
})

Tabs.Interact:AddSection("NPC Actions")

Tabs.Interact:AddButton({
    Title = "Drop Bag on Ground",
    Description = "Throws the bag you're holding",
    Callback = function()
        safeCall(function()
            local rs = getRS()
            if rs then
                rs.Remotes.ThrowBag:FireServer(Vector3.new(-0.98, -0.16, 0.07))
                notify("Interact", "Bag thrown!")
            end
        end, "Error throwing bag")
    end
})

Tabs.Interact:AddButton({
    Title = "Yell at All Civilians",
    Description = "Intimidates all civilian NPCs",
    Callback = function()
        safeCall(function()
            local citizens = Workspace:FindFirstChild("Citizens")
            if citizens then
                local targetList = {}
                for _, citizen in pairs(citizens:GetChildren()) do
                    table.insert(targetList, citizen)
                end
                
                local rs = getRS()
                if rs then
                    rs.Remotes.PlayerYell:FireServer(targetList)
                    notify("Interact", "Yelling at " .. #targetList .. " civilians")
                end
            else
                notify("Interact", "No civilians found!")
            end
        end, "Error yelling")
    end
})

-- ==================== DESTRUCTION TAB ====================
Tabs.Destruction:AddSection("Destruction")

Tabs.Destruction:AddButton({
    Title = "üí• Break All Glass",
    Description = "Destroys all glass on the map",
    Callback = function()
        local tool = getTool()
        if not tool then 
            notify("Error", "Hold a weapon!")
            return 
        end
        
        local glassFolder = Workspace:FindFirstChild("Glass")
        if glassFolder then
            local count = 0
            for _, glass in pairs(glassFolder:GetChildren()) do
                if glass:IsA("BasePart") then
                    if fireHit(tool, glass) then
                        count = count + 1
                    end
                end
                
                if count % 20 == 0 then 
                    task.wait(0.05) 
                end
            end
            notify("Destruction", count .. " glass broken!", 4)
        else
            notify("Destruction", "No glass found!")
        end
    end
})

Tabs.Destruction:AddButton({
    Title = "üìπ Destroy All Cameras",
    Description = "Breaks active and already broken cameras",
    Callback = function()
        local tool = getTool()
        if not tool then 
            notify("Error", "Hold a weapon!")
            return 
        end
        
        local count = 0
        for _, folderName in ipairs({"Cameras", "BrokenCameras"}) do
            local folder = Workspace:FindFirstChild(folderName)
            if folder then
                for _, cam in pairs(folder:GetChildren()) do
                    local part = cam:FindFirstChild("Union") 
                              or cam:FindFirstChild("Head") 
                              or cam:FindFirstChildOfClass("MeshPart")
                    
                    if part then
                        if fireHit(tool, part) then
                            count = count + 1
                        end
                    end
                end
            end
        end
        
        notify("Destruction", count .. " cameras destroyed!", 4)
    end
})

-- ==================== PLAYER MOD TAB ====================
Tabs.Player:AddSection("Movement")

Tabs.Player:AddToggle("InfiniteStamina", {
    Title = "‚ôæÔ∏è Infinite Stamina",
    Description = "Never get tired",
    Default = false,
    Callback = function(value)
        infiniteStaminaEnabled = value
        
        if infiniteStaminaLoop then
            infiniteStaminaLoop:Disconnect()
            infiniteStaminaLoop = nil
        end
        
        if value then
            infiniteStaminaLoop = RunService.Heartbeat:Connect(function()
                safeCall(function()
                    local criminals = Workspace:FindFirstChild("Criminals")
                    if criminals then
                        local playerModel = criminals:FindFirstChild(LocalPlayer.Name)
                        if playerModel then
                            local stamina = playerModel:FindFirstChild("Stamina")
                            local maxStamina = playerModel:FindFirstChild("MaxStamina")
                            
                            if stamina then stamina.Value = 90000 end
                            if maxStamina then maxStamina.Value = 90000 end
                        end
                    end
                end)
            end)
            notify("Player", "Infinite Stamina enabled!")
        else
            notify("Player", "Infinite Stamina disabled")
        end
    end
})

Tabs.Player:AddSlider("WalkSpeed", {
    Title = "Movement Speed",
    Description = "Controls TP Walk speed",
    Default = 50,
    Min = 16,
    Max = 200,
    Rounding = 1,
    Callback = function(value)
        walkSpeedValue = value
    end
})

Tabs.Player:AddToggle("WalkSpeedToggle", {
    Title = "üöÄ TP Walk",
    Description = "Fast movement (safe)",
    Default = false,
    Callback = function(value)
        walkSpeedEnabled = value
        
        -- IMPORTANT: Clear previous connection
        if tpWalkConnection then
            tpWalkConnection:Disconnect()
            tpWalkConnection = nil
        end
        
        if value then
            tpWalkConnection = RunService.Heartbeat:Connect(function()
                if not walkSpeedEnabled then return end
                
                safeCall(function()
                    local character = LocalPlayer.Character
                    if not character then return end
                    
                    local hrp = character:FindFirstChild("HumanoidRootPart")
                    local humanoid = character:FindFirstChildOfClass("Humanoid")
                    
                    if hrp and humanoid and humanoid.MoveDirection.Magnitude > 0 then
                        local moveSpeed = walkSpeedValue / 50
                        hrp.CFrame = hrp.CFrame + (humanoid.MoveDirection * moveSpeed)
                    end
                end)
            end)
            notify("Player", "TP Walk enabled - Speed: " .. walkSpeedValue)
        else
            notify("Player", "TP Walk disabled")
        end
    end
})

Tabs.Player:AddToggle("InfiniteJump", {
    Title = "Infinite Jump",
    Description = "Jump infinitely in the air",
    Default = false,
    Callback = function(value)
        infiniteJumpEnabled = value
        
        if infJumpConnection then
            infJumpConnection:Disconnect()
            infJumpConnection = nil
        end
        
        if value then
            infJumpConnection = UserInputService.JumpRequest:Connect(function()
                if not infiniteJumpEnabled then return end
                
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChildOfClass("Humanoid")
                    if humanoid then
                        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                end
            end)
            notify("Player", "Infinite Jump enabled!")
        else
            notify("Player", "Infinite Jump disabled")
        end
    end
})

Tabs.Player:AddSection("Physics")

Tabs.Player:AddSlider("Gravity", {
    Title = "Gravity",
    Description = "Controls world gravity",
    Default = 196.2,
    Min = 0,
    Max = 196.2,
    Rounding = 1,
    Callback = function(value)
        gravityValue = value
    end
})

Tabs.Player:AddToggle("GravityToggle", {
    Title = "Enable Custom Gravity",
    Description = "Applies configured gravity",
    Default = false,
    Callback = function(value)
        customGravityEnabled = value
        
        if gravityLoop then
            gravityLoop:Disconnect()
            gravityLoop = nil
        end
        
        if value then
            gravityLoop = RunService.Heartbeat:Connect(function()
                if customGravityEnabled then
                    Workspace.Gravity = gravityValue
                end
            end)
            notify("Player", "Gravity: " .. gravityValue)
        else
            Workspace.Gravity = 196.2
            notify("Player", "Gravity reset")
        end
    end
})

Tabs.Player:AddToggle("Noclip", {
    Title = "üëª Noclip",
    Description = "Walk through walls",
    Default = false,
    Callback = function(value)
        noclipEnabled = value
        
        if noclipLoop then
            noclipLoop:Disconnect()
            noclipLoop = nil
        end
        
        if value then
            noclipLoop = RunService.Stepped:Connect(function()
                if not noclipEnabled then return end
                
                safeCall(function()
                    local character = LocalPlayer.Character
                    if character then
                        for _, part in pairs(character:GetDescendants()) do
                            if part:IsA("BasePart") and part.CanCollide then
                                part.CanCollide = false
                            end
                        end
                    end
                end)
            end)
            notify("Player", "Noclip enabled!")
        else
            -- Restore collision
            safeCall(function()
                local character = LocalPlayer.Character
                if character then
                    for _, part in pairs(character:GetDescendants()) do
                        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                            part.CanCollide = true
                        end
                    end
                end
            end)
            notify("Player", "Noclip disabled")
        end
    end
})

-- ==================== COMBAT TAB ====================
Tabs.Aim:AddSection("Kill All")

Tabs.Aim:AddToggle("KillAllLoop", {
    Title = "üî• Kill All (Loop)",
    Description = "Automatically kills all police",
    Default = false,
    Callback = function(value)
        killAllEnabled = value
        
        if value then
            task.spawn(function()
                notify("Kill All Loop", "Loop ENABLED!", 3)
                lastKillAllNotify = tick() -- Reset timer
                
                while killAllEnabled do
                    killAllPolice()
                    task.wait(killAllDelay)
                end
                
                notify("Kill All Loop", "Loop disabled", 2)
            end)
        end
    end
})

Tabs.Aim:AddButton({
    Title = "Kill All (Once)",
    Description = "Executes kill all once",
    Callback = killAllPolice
})

Tabs.Aim:AddSection("Kill Aura")

Tabs.Aim:AddToggle("KillAura", {
    Title = "‚öîÔ∏è Kill Aura (Improved)",
    Description = "Kills nearby enemies when aiming (Right Click)",
    Default = false,
    Callback = function(value)
        kaEnabled = value
        if value then
            notify("Kill Aura", "ENABLED - Hold right mouse button!", 4)
        else
            notify("Kill Aura", "Disabled", 2)
        end
    end
})

Tabs.Aim:AddToggle("KAAutoAim", {
    Title = "Auto-Aim on Kill Aura",
    Description = "Automatically aims at kill aura target",
    Default = true,
    Callback = function(value)
        kaAutoAim = value
    end
})

Tabs.Aim:AddSlider("KARange", {
    Title = "Kill Aura Range",
    Description = "Maximum distance to attack",
    Default = 70,
    Min = 20,
    Max = 150,
    Rounding = 1,
    Callback = function(value)
        kaRange = value
    end
})

Tabs.Aim:AddSlider("KADelay", {
    Title = "Kill Aura Delay",
    Description = "Time between attacks (seconds)",
    Default = 0.1,
    Min = 0.05,
    Max = 0.5,
    Rounding = 2,
    Callback = function(value)
        kaDelay = value
    end
})

Tabs.Aim:AddSection("Aimbot")

Tabs.Aim:AddToggle("AimEnabled", {
    Title = "üéØ Aimbot",
    Description = "Automatically aims when holding right click",
    Default = false,
    Callback = function(value)
        aimEnabled = value
        if not value then
            aiming = false
            currentTarget = nil
        end
        notify("Aim", value and "Aimbot enabled!" or "Aimbot disabled", 2)
    end
})

Tabs.Aim:AddDropdown("AimPart", {
    Title = "Target Part",
    Description = "Where to aim on enemy",
    Values = {"Head", "HumanoidRootPart", "Torso", "UpperTorso", "LowerTorso"},
    Default = 1,
    Callback = function(value)
        aimPart = value
    end
})

Tabs.Aim:AddSlider("AimFOV", {
    Title = "Aimbot FOV",
    Description = "Detection radius",
    Default = 200,
    Min = 50,
    Max = 500,
    Rounding = 1,
    Callback = function(value)
        aimFOV = value
        FOVCircle.Radius = value
    end
})

Tabs.Aim:AddSlider("AimSensitivity", {
    Title = "Sensitivity",
    Description = "Aim smoothness (higher = faster)",
    Default = 50,
    Min = 1,
    Max = 100,
    Rounding = 1,
    Callback = function(value)
        aimSensitivity = value
    end
})

Tabs.Aim:AddToggle("UseSensitivity", {
    Title = "Use Sensitivity",
    Description = "Enables smooth movement",
    Default = true,
    Callback = function(value)
        useSensitivity = value
    end
})

Tabs.Aim:AddToggle("ShowFOV", {
    Title = "Show FOV Circle",
    Description = "Visualizes aimbot radius",
    Default = false,
    Callback = function(value)
        fovCircleEnabled = value
        FOVCircle.Visible = value
    end
})

-- ==================== ESP TAB ====================
Tabs.ESP:AddSection("ESP (Highlights)")

Tabs.ESP:AddToggle("CameraESP", {
    Title = "üìπ Camera ESP",
    Description = "Red = active | Orange = broken",
    Default = false,
    Callback = function(value)
        cameraESPEnabled = value
        
        if value then
            task.spawn(function()
                while cameraESPEnabled do
                    clearHighlights(cameraHighlights)
                    
                    safeCall(function()
                        for _, folderName in ipairs({"Cameras", "BrokenCameras"}) do
                            local folder = Workspace:FindFirstChild(folderName)
                            if folder then
                                for _, cam in pairs(folder:GetChildren()) do
                                    local color = (folderName == "BrokenCameras") 
                                        and Color3.fromRGB(255, 165, 0) 
                                        or Color3.fromRGB(255, 0, 0)
                                    
                                    local hl = createHighlight(cam, color)
                                    if hl then
                                        table.insert(cameraHighlights, hl)
                                    end
                                end
                            end
                        end
                    end)
                    
                    task.wait(2)
                end
                clearHighlights(cameraHighlights)
            end)
        else
            clearHighlights(cameraHighlights)
        end
    end
})

Tabs.ESP:AddToggle("PoliceESP", {
    Title = "üëÆ Police ESP",
    Description = "Highlights police in blue",
    Default = false,
    Callback = function(value)
        policeESPEnabled = value
        
        if value then
            task.spawn(function()
                while policeESPEnabled do
                    clearHighlights(policeHighlights)
                    
                    safeCall(function()
                        for _, folderName in ipairs({"Police", "Bodies"}) do
                            local folder = Workspace:FindFirstChild(folderName)
                            if folder then
                                for _, cop in pairs(folder:GetChildren()) do
                                    local hl = createHighlight(cop, Color3.fromRGB(0, 100, 255))
                                    if hl then
                                        table.insert(policeHighlights, hl)
                                    end
                                end
                            end
                        end
                    end)
                    
                    task.wait(2)
                end
                clearHighlights(policeHighlights)
            end)
        else
            clearHighlights(policeHighlights)
        end
    end
})

Tabs.ESP:AddToggle("CivilianESP", {
    Title = "üë• Civilian ESP",
    Description = "Green = free | Yellow = tied",
    Default = false,
    Callback = function(value)
        civilianESPEnabled = value
        
        if value then
            task.spawn(function()
                while civilianESPEnabled do
                    clearHighlights(civilianHighlights)
                    
                    safeCall(function()
                        local citizens = Workspace:FindFirstChild("Citizens")
                        if citizens then
                            for _, citizen in pairs(citizens:GetChildren()) do
                                local isTied = string.find(citizen.Name:lower(), "tied")
                                local color = isTied 
                                    and Color3.fromRGB(255, 255, 0) 
                                    or Color3.fromRGB(0, 255, 0)
                                
                                local hl = createHighlight(citizen, color)
                                if hl then
                                    table.insert(civilianHighlights, hl)
                                end
                            end
                        end
                    end)
                    
                    task.wait(2)
                end
                clearHighlights(civilianHighlights)
            end)
        else
            clearHighlights(civilianHighlights)
        end
    end
})

-- ==================== SPECIFIC MAPS TAB ====================
Tabs.Maps:AddSection("Map Selection")

local mapESPSection = nil
local mapTeleportSection = nil

Tabs.Maps:AddDropdown("MapSelect", {
    Title = "üó∫Ô∏è Select Map",
    Description = "Choose map for specific features",
    Values = {"The Ozela Heist"},
    Default = 1,
    Callback = function(value)
        selectedMap = value
    end
})

Tabs.Maps:AddButton({
    Title = "‚úÖ Confirm Map",
    Description = "Loads features for selected map",
    Callback = function()
        if selectedMap == "The Ozela Heist" then
            -- Remove old sections if they exist
            if mapESPSection then
                pcall(function() mapESPSection:Destroy() end)
            end
            if mapTeleportSection then
                pcall(function() mapTeleportSection:Destroy() end)
            end
            
            -- Create new sections
            Tabs.Maps:AddSection("ESP - " .. selectedMap)
            
            Tabs.Maps:AddToggle("RopeESP", {
                Title = "ü™¢ Rope ESP",
                Description = "Highlights ropes (yellow)",
                Default = false,
                Callback = function(value)
                    ropeESPEnabled = value
                    
                    if ropeESPLoop then
                        ropeESPLoop:Disconnect()
                        ropeESPLoop = nil
                    end
                    
                    if value then
                        task.spawn(function()
                            while ropeESPEnabled do
                                clearHighlights(ropeHighlights)
                                
                                safeCall(function()
                                    local mapEntities = Workspace:FindFirstChild("mapEntities")
                                    if mapEntities then
                                        local missionItems = mapEntities:FindFirstChild("missionItems")
                                        if missionItems then
                                            local ropes = missionItems:FindFirstChild("Ropes")
                                            if ropes then
                                                for _, rope in pairs(ropes:GetChildren()) do
                                                    local hl = createHighlight(rope, Color3.fromRGB(255, 255, 0))
                                                    if hl then
                                                        table.insert(ropeHighlights, hl)
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end)
                                
                                task.wait(2)
                            end
                            clearHighlights(ropeHighlights)
                        end)
                        notify("Rope ESP", "Enabled!", 2)
                    else
                        clearHighlights(ropeHighlights)
                        notify("Rope ESP", "Disabled", 2)
                    end
                end
            })
            
            Tabs.Maps:AddToggle("HookESP", {
                Title = "ü™ù Hook ESP",
                Description = "Highlights hooks (lime green)",
                Default = false,
                Callback = function(value)
                    hookESPEnabled = value
                    
                    if hookESPLoop then
                        hookESPLoop:Disconnect()
                        hookESPLoop = nil
                    end
                    
                    if value then
                        task.spawn(function()
                            while hookESPEnabled do
                                clearHighlights(hookHighlights)
                                
                                safeCall(function()
                                    local mapEntities = Workspace:FindFirstChild("mapEntities")
                                    if mapEntities then
                                        local missionItems = mapEntities:FindFirstChild("missionItems")
                                        if missionItems then
                                            local hooks = missionItems:FindFirstChild("Hooks")
                                            if hooks then
                                                for _, hook in pairs(hooks:GetChildren()) do
                                                    local hl = createHighlight(hook, Color3.fromRGB(0, 255, 100))
                                                    if hl then
                                                        table.insert(hookHighlights, hl)
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end)
                                
                                task.wait(2)
                            end
                            clearHighlights(hookHighlights)
                        end)
                        notify("Hook ESP", "Enabled!", 2)
                    else
                        clearHighlights(hookHighlights)
                        notify("Hook ESP", "Disabled", 2)
                    end
                end
            })
            
            Tabs.Maps:AddToggle("CodeTableESP", {
                Title = "üìã Code Table ESP",
                Description = "Highlights code table (purple)",
                Default = false,
                Callback = function(value)
                    codeTableESPEnabled = value
                    
                    if codeTableESPLoop then
                        codeTableESPLoop:Disconnect()
                        codeTableESPLoop = nil
                    end
                    
                    if value then
                        task.spawn(function()
                            while codeTableESPEnabled do
                                clearHighlights(codeTableHighlights)
                                
                                safeCall(function()
                                    local blueprints = Workspace:FindFirstChild("Blueprints")
                                    if blueprints then
                                        local stadiumBlueprint = blueprints:FindFirstChild("prop_stadium_blueprintTableRNG")
                                        if stadiumBlueprint then
                                            local codeTable = stadiumBlueprint:FindFirstChild("prop_office_TablePlastic")
                                            if codeTable then
                                                local hl = createHighlight(codeTable, Color3.fromRGB(200, 0, 255))
                                                if hl then
                                                    table.insert(codeTableHighlights, hl)
                                                end
                                            end
                                        end
                                    end
                                end)
                                
                                task.wait(2)
                            end
                            clearHighlights(codeTableHighlights)
                        end)
                        notify("Code Table ESP", "Enabled!", 2)
                    else
                        clearHighlights(codeTableHighlights)
                        notify("Code Table ESP", "Disabled", 2)
                    end
                end
            })
            
            -- Teleport Section
            Tabs.Maps:AddSection("Teleport - " .. selectedMap)
            
            Tabs.Maps:AddButton({
                Title = "üìç TP to Nearest Rope",
                Description = "Teleports to closest rope",
                Callback = function()
                    safeCall(function()
                        local character = LocalPlayer.Character
                        if not character or not character:FindFirstChild("HumanoidRootPart") then
                            notify("Teleport", "Character not found!")
                            return
                        end
                        
                        local hrp = character.HumanoidRootPart
                        local mapEntities = Workspace:FindFirstChild("mapEntities")
                        
                        if mapEntities then
                            local missionItems = mapEntities:FindFirstChild("missionItems")
                            if missionItems then
                                local ropes = missionItems:FindFirstChild("Ropes")
                                if ropes then
                                    local closest = nil
                                    local shortestDist = math.huge
                                    
                                    for _, rope in pairs(ropes:GetChildren()) do
                                        if rope:IsA("Model") or rope:IsA("Part") then
                                            local ropePart = rope:IsA("Part") and rope or rope:FindFirstChildOfClass("Part")
                                            if ropePart then
                                                local dist = (hrp.Position - ropePart.Position).Magnitude
                                                if dist < shortestDist then
                                                    closest = ropePart
                                                    shortestDist = dist
                                                end
                                            end
                                        end
                                    end
                                    
                                    if closest then
                                        hrp.CFrame = closest.CFrame + Vector3.new(0, 3, 0)
                                        notify("Teleport", "Teleported to Rope!", 2)
                                    else
                                        notify("Teleport", "No Rope found!")
                                    end
                                else
                                    notify("Teleport", "Ropes folder not found!")
                                end
                            end
                        end
                    end, "Error teleporting")
                end
            })
            
            Tabs.Maps:AddButton({
                Title = "üìç TP to Nearest Hook",
                Description = "Teleports to closest hook",
                Callback = function()
                    safeCall(function()
                        local character = LocalPlayer.Character
                        if not character or not character:FindFirstChild("HumanoidRootPart") then
                            notify("Teleport", "Character not found!")
                            return
                        end
                        
                        local hrp = character.HumanoidRootPart
                        local mapEntities = Workspace:FindFirstChild("mapEntities")
                        
                        if mapEntities then
                            local missionItems = mapEntities:FindFirstChild("missionItems")
                            if missionItems then
                                local hooks = missionItems:FindFirstChild("Hooks")
                                if hooks then
                                    local closest = nil
                                    local shortestDist = math.huge
                                    
                                    for _, hook in pairs(hooks:GetChildren()) do
                                        if hook:IsA("Model") or hook:IsA("Part") then
                                            local hookPart = hook:IsA("Part") and hook or hook:FindFirstChildOfClass("Part")
                                            if hookPart then
                                                local dist = (hrp.Position - hookPart.Position).Magnitude
                                                if dist < shortestDist then
                                                    closest = hookPart
                                                    shortestDist = dist
                                                end
                                            end
                                        end
                                    end
                                    
                                    if closest then
                                        hrp.CFrame = closest.CFrame + Vector3.new(0, 3, 0)
                                        notify("Teleport", "Teleported to Hook!", 2)
                                    else
                                        notify("Teleport", "No Hook found!")
                                    end
                                else
                                    notify("Teleport", "Hooks folder not found!")
                                end
                            end
                        end
                    end, "Error teleporting")
                end
            })
            
            Tabs.Maps:AddButton({
                Title = "üìç TP to Code Table",
                Description = "Teleports to code table",
                Callback = function()
                    safeCall(function()
                        local character = LocalPlayer.Character
                        if not character or not character:FindFirstChild("HumanoidRootPart") then
                            notify("Teleport", "Character not found!")
                            return
                        end
                        
                        local hrp = character.HumanoidRootPart
                        local blueprints = Workspace:FindFirstChild("Blueprints")
                        
                        if blueprints then
                            local stadiumBlueprint = blueprints:FindFirstChild("prop_stadium_blueprintTableRNG")
                            if stadiumBlueprint then
                                local codeTable = stadiumBlueprint:FindFirstChild("prop_office_TablePlastic")
                                if codeTable then
                                    local tablePart = codeTable:IsA("Part") and codeTable or codeTable:FindFirstChildOfClass("Part")
                                    if tablePart then
                                        hrp.CFrame = tablePart.CFrame + Vector3.new(0, 5, 0)
                                        notify("Teleport", "Teleported to Code Table!", 2)
                                    else
                                        notify("Teleport", "Table part not found!")
                                    end
                                else
                                    notify("Teleport", "Code Table not found!")
                                end
                            else
                                notify("Teleport", "Stadium Blueprint not found!")
                            end
                        else
                            notify("Teleport", "Blueprints folder not found!")
                        end
                    end, "Error teleporting")
                end
            })
            
            notify("Specific Maps", "Features for " .. selectedMap .. " loaded!", 3)
        end
    end
})

-- ==================== GAME STATS TAB ====================
Tabs.Stats:AddSection("Player Statistics")

local statsParagraph = Tabs.Stats:AddParagraph({
    Title = "üìä Your Statistics",
    Content = "Click the button below to load your stats."
})

Tabs.Stats:AddButton({
    Title = "üîÑ Refresh Statistics",
    Description = "Loads your stats from server",
    Callback = function()
        safeCall(function()
            local rs = getRS()
            if not rs then
                notify("Stats", "Error accessing ReplicatedStorage!")
                return
            end
            
            notify("Stats", "Loading statistics...", 2)
            
            local stats = rs.Remotes.GetStats:InvokeServer()
            
            if stats then
                local statsText = "üìä Your Statistics:\n\n"
                
                -- Nice formatting for stats
                statsText = statsText .. "üéØ Kills:\n"
                statsText = statsText .. "  ‚Ä¢ Police Killed: " .. (stats.PoliceKills or 0) .. "\n"
                statsText = statsText .. "  ‚Ä¢ Civilians Killed: " .. (stats.CivilianKills or 0) .. "\n"
                statsText = statsText .. "  ‚Ä¢ Headshots: " .. (stats.Headshots or 0) .. "\n\n"
                
                statsText = statsText .. "üí∞ Money:\n"
                statsText = statsText .. "  ‚Ä¢ Instant Cash: $" .. (stats.InstantCash or 0) .. "\n\n"
                
                statsText = statsText .. "üè• Support:\n"
                statsText = statsText .. "  ‚Ä¢ Revives: " .. (stats.Revives or 0) .. "\n"
                statsText = statsText .. "  ‚Ä¢ Downs (Knocked): " .. (stats.Downs or 0) .. "\n\n"
                
                statsText = statsText .. "üî´ Weapon Stats:\n"
                if stats.GunStats and type(stats.GunStats) == "table" then
                    local hasGunStats = false
                    for gunName, gunData in pairs(stats.GunStats) do
                        if type(gunData) == "table" then
                            hasGunStats = true
                            statsText = statsText .. "  ‚Ä¢ " .. gunName .. ":\n"
                            if gunData.Kills then
                                statsText = statsText .. "    - Kills: " .. gunData.Kills .. "\n"
                            end
                            if gunData.Shots then
                                statsText = statsText .. "    - Shots: " .. gunData.Shots .. "\n"
                            end
                            if gunData.Headshots then
                                statsText = statsText .. "    - Headshots: " .. gunData.Headshots .. "\n"
                            end
                        end
                    end
                    if not hasGunStats then
                        statsText = statsText .. "  ‚Ä¢ No weapon stats recorded\n"
                    end
                else
                    statsText = statsText .. "  ‚Ä¢ No weapon stats available\n"
                end
                
                statsText = statsText .. "\nüéÆ Interactions:\n"
                statsText = statsText .. "  ‚Ä¢ Total: " .. (stats.Interactions or 0)
                
                statsParagraph:SetDesc(statsText)
                notify("Stats", "Statistics loaded successfully!", 3)
            else
                statsParagraph:SetDesc("‚ùå Error loading statistics.\n\nTry again in a few seconds.")
                notify("Stats", "Failed to load stats!")
            end
        end, "Error loading statistics")
    end
})

Tabs.Stats:AddSection("Additional Information")

Tabs.Stats:AddParagraph({
    Title = "‚ÑπÔ∏è About Stats",
    Content = "Statistics are loaded directly from the game server.\n\n" ..
              "‚Ä¢ PoliceKills: Total police eliminated\n" ..
              "‚Ä¢ CivilianKills: Total civilians eliminated\n" ..
              "‚Ä¢ Headshots: Total headshots\n" ..
              "‚Ä¢ InstantCash: Money earned instantly\n" ..
              "‚Ä¢ Revives: Times you revived allies\n" ..
              "‚Ä¢ Downs: Times you were knocked down\n" ..
              "‚Ä¢ GunStats: Statistics per weapon\n" ..
              "‚Ä¢ Interactions: Total in-game interactions"
})

-- ==================== INPUT HANDLING ====================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        if aimEnabled or kaEnabled then
            aiming = true
        end
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        aiming = false
        currentTarget = nil
    end
end)

-- ==================== MAIN LOOP ====================
RunService.RenderStepped:Connect(function()
    -- FOV Circle
    if fovCircleEnabled then
        local mouseLocation = UserInputService:GetMouseLocation()
        FOVCircle.Position = Vector2.new(mouseLocation.X, mouseLocation.Y)
        FOVCircle.Visible = true
    else
        FOVCircle.Visible = false
    end
    
    -- Get closest target
    local target = getClosestPolice()
    currentTarget = target
    
    -- Aimbot
    if aimEnabled and aiming and target then
        aimAtTarget(target)
    end
    
    -- Kill Aura (IMPROVED)
    if kaEnabled and aiming and target then
        local currentTime = tick()
        
        -- Auto-aim on kill aura
        if kaAutoAim then
            aimAtTarget(target)
        end
        
        -- Check delay
        if currentTime - lastKaTime >= kaDelay then
            local character = LocalPlayer.Character
            if character then
                local hrp = character:FindFirstChild("HumanoidRootPart")
                local targetHrp = target:FindFirstChild("HumanoidRootPart")
                
                if hrp and targetHrp then
                    local distance = (hrp.Position - targetHrp.Position).Magnitude
                    
                    if distance <= kaRange then
                        -- Attack multiple times to ensure kill
                        for i = 1, 2 do
                            executeKillAura(target)
                            task.wait(0.01)
                        end
                        lastKaTime = currentTime
                    end
                end
            end
        end
    end
end)

-- ==================== CLEANUP ====================
local function cleanup()
    -- Clear ESPs
    clearHighlights(cameraHighlights)
    clearHighlights(policeHighlights)
    clearHighlights(civilianHighlights)
    clearHighlights(ropeHighlights)
    clearHighlights(hookHighlights)
    clearHighlights(codeTableHighlights)
    
    -- Clear FOV Circle
    if FOVCircle then
        FOVCircle:Remove()
    end
    
    -- Disconnect loops
    if tpWalkConnection then tpWalkConnection:Disconnect() end
    if infJumpConnection then infJumpConnection:Disconnect() end
    if noclipLoop then noclipLoop:Disconnect() end
    if gravityLoop then gravityLoop:Disconnect() end
    if infiniteStaminaLoop then infiniteStaminaLoop:Disconnect() end
    if instantInteractConnection then instantInteractConnection:Disconnect() end
    if ropeESPLoop then ropeESPLoop:Disconnect() end
    if hookESPLoop then hookESPLoop:Disconnect() end
    if codeTableESPLoop then codeTableESPLoop:Disconnect() end
    
    -- Reset values
    Workspace.Gravity = 196.2
    
    notify("XXMZ HUB", "Cleanup completed!", 2)
end

-- Cleanup on teleport
Players.LocalPlayer.OnTeleport:Connect(cleanup)

-- Cleanup on death
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    if noclipEnabled then
        -- Reapply noclip after spawn
        noclipEnabled = false
        task.wait(0.1)
        noclipEnabled = true
    end
end)

-- ==================== COMPLETE INITIALIZATION ====================
notify("XXMZ HUB v2.0", "Hub loaded successfully! ‚úÖ", 5)
notify("Created by", "29 :)", 3)
